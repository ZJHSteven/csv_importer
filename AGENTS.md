# AGENTS.md

本文件用于记录插件改动与当前状态，方便追踪每次更新。

## 最近更新
- 初始化 AGENTS.md，占位并开始记录。

- 新增 addon_errors.py：集中异常与日志接口。

- 新增 addon_models.py：定义解析/导入/TTS 的数据结构。

- 新增 addon_config.py：集中管理默认配置与读写逻辑。

- 新增 addon_parser.py：解析混合格式文本并输出分段结构。

- 新增 addon_anki.py：封装 Anki 集合交互操作。

- 新增 addon_importer.py：实现导入流程与重复处理。

- 新增 addon_tts.py：实现 Azure TTS 合成与媒体写入。

- 新增 addon_ui.py：实现导入与 TTS 的中文界面。

- 更新 __init__.py：注册菜单入口并打开主界面。

- 更新 README.md：补充格式示例、使用步骤与说明。

- 新增 config.json：提供默认配置模板。

- 更新 addon_tts.py：完善默认音色判断与字段名获取。

- 更新 addon_anki.py：章节标签取牌堆最后一级。

- 更新 addon_parser.py：支持题型行后紧跟内容。

- 更新 addon_importer.py：标签分隔符由配置控制。

- 更新内部模块导入：统一改为相对导入，修复插件加载时模块找不到的问题。

- 修复 Qt6 下 QLineEdit 回显模式设置：改为使用 EchoMode.Password。

- 修复题型识别误判：忽略引号内冒号，避免把 CSV 内容当题型行。

- 安全处理集合为空的情况：TTS 扫描前检测 mw.col 并提示用户。

- 忽略运行时生成的 meta.json，避免误提交。

- 优化 TTS 扫描与错误提示：按标签过滤导入范围、校验 base_url/Key、跳过已有音频并输出更详细的失败信息。

- 重复处理模式改为中文显示并兼容旧英文值。

- TTS 增加语速配置，并在选择音色时同步默认语言到音色 Locale。

- 新增导入会话记录与回滚：保存导入明细、支持重复项二次更新，并可自动打开浏览器定位结果。

- TTS 扫描支持牌组筛选、完成后打开浏览器，复用已有媒体不再误计为跳过。

- 新增 SSML 模板重置按钮，便于恢复默认模板。

- 修复导入界面方法归属与 PyQt6 枚举，并补充空值防护以消除报错。

- 解决导入页勾选框与方法同名冲突，修复 Pylance 类型报错。

- 修复浏览器搜索兼容性：当 search() 无参数时改用写入搜索框再触发。

- 兼容搜索框为 QComboBox 的情况，避免 setText 报错。

- 调整搜索框控件类型标注，消除静态检查误报。

- 简化浏览器查询语句为 nid:1,2 形式，并确保自动触发搜索。

- TTS 牌组选择改为树状层级显示，并忽略 debug.log 日志文件。

- TTS 支持后台执行、并发与进度回调，并增加覆盖生成与倍率语速配置。

- 新增会话页面与策略调整逻辑，补充重复笔记快照、策略覆盖与长期保留配置。

- 主界面改为非模态，避免阻塞 Anki 其它窗口操作。

- 更新 README：补充会话页、树状牌组与 TTS 后台并发说明。

- 修复 TTS 标记清理的正则字符串语法错误，避免插件启动失败。

- 修复 Pylance 类型误报：为会话与回滚返回值及条目追加显式类型标注。

- 章节标签改为按牌堆各层级拆分并去重追加，避免已有标签重复写入。
