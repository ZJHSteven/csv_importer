# CSV 批量导入与 TTS 插件

## 功能概览
- 支持一个文件内混合多个题型与多个牌堆
- 通过“牌堆行 + 题型行”进行段落切分
- CSV 行按英文逗号分隔，支持双引号包裹
- 导入时自动补充章节标签与题型标签
- TTS 支持 Azure（可扩展），自动写入媒体并插入音频标记
- 导入自动生成会话记录，可回滚并支持重复项策略调整（更新/复制/跳过）
- 导入/TTS 完成后可自动打开浏览器定位结果
- TTS 后台执行支持进度显示与并发控制，避免卡顿

## 文件格式（推荐）
> 牌堆行以 `//` 开头；题型行以中文或英文冒号结尾。

```text
//生理::英文::第一章
问答题：
"What are the three basic functions of the nervous system?","神经系统的三项基本功能是什么？<br>...","神经系统 总览"
"central nervous system (CNS)","音标：...<br>释义：中枢神经系统","神经系统 总览"

填空题：
"The brainstem is composed of the {{c1::midbrain}}, {{c1::pons}}, and {{c1::medulla oblongata}}.","脑干由{{中脑}}、{{脑桥}}、{{延髓}}组成。","神经系统 总览"
```

## 使用步骤（最小可运行）
1. 将插件目录放入 Anki 的 `addons21` 目录（或通过打包安装）。
2. 打开 Anki → 工具 → `CSV 批量导入与 TTS`。
3. 选择导入文件 → 点击“解析文件”查看分段与警告。
4. 确认重复处理方式（默认保留重复）→ 点击“开始导入”。
5. 如需 TTS：切换到 TTS 页，填写 Azure Base URL 与 Key，拉取音色并选择默认音色。
6. 如需限制牌组范围，可在树状牌组列表中选择目标牌组。
7. 点击“扫描待生成音频” → “开始生成”（后台执行并显示进度）。
8. 如需调整重复策略：切换到“会话”页，选择会话与条目后应用新策略。

## 重要说明
- 当前默认使用“第一个字段”作为重复检测条件；重复检测仅在目标牌堆内进行。
- CSV 行字段数少于笔记类型字段数时会自动补空；多余字段会合并到最后一列。
- 当 CSV 列数比笔记类型字段数多 1 列时，最后一列默认视为标签列。
- TTS 仅对“带英文标签的笔记”生效，可在配置中修改标签名。
- 导入会话记录保存在 `user_files/import_sessions`，可用于回滚或重复项二次更新。
- 覆盖已生成音频时会重写媒体并更新标记；语速支持填写倍率（如 0.8/1.0/1.2）。

## 可配置项（简要）
- 默认导入路径、重复处理模式（保留重复/覆盖更新/跳过重复）、是否允许 HTML、导入后自动打开浏览器
- 题型名称与 Anki 笔记类型的映射
- Azure TTS Base URL、Key、默认音色、语速倍率、SSML 模板、并发数量、覆盖模式、扫描牌组范围、TTS 完成后打开浏览器
